name: 1. Deploy from Zip

on:
  workflow_dispatch: # Bot√≥n manual
  push:
    paths:
      - '**.zip' # Se activa autom√°ticamente si subes un ZIP

jobs:
  unzip-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Unzip Source
        run: |
          # Busca cualquier archivo .zip en la ra√≠z
          if ls *.zip 1> /dev/null 2>&1; then
            echo "üì¶ ZIP detectado. Descomprimiendo..."
            
            # -o: Sobrescribir archivos existentes
            # -x ".github/*": IMPORTANTE - Excluir la carpeta de workflows para evitar error de permisos
            # -d .: Extraer en el directorio actual
            unzip -o *.zip -x ".github/*" -d .
            
            # Si el zip cre√≥ una subcarpeta (ej: Mercado-main/), sacar archivos a la ra√≠z
            if [ -d "Mercado-main" ]; then
              cp -r Mercado-main/* .
              rm -rf Mercado-main
            fi

            # Limpieza
            echo "üóëÔ∏è Eliminando ZIP original..."
            rm *.zip
            
            # Configurar git para guardar los cambios
            git config --global user.name 'GitHub Action'
            git config --global user.email 'action@github.com'
            git add .
            # Hacemos commit solo si hay cambios en el c√≥digo fuente (src, scripts, etc.)
            git diff --quiet && git diff --staged --quiet || (git commit -m "Deploy: Unzipped source files" && git push)
          else
            echo "‚úÖ No se encontr√≥ archivo .zip. Nada que hacer."
          fi
