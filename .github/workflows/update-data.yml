
name: Deploy from Zip & Update Data

on:
  schedule:
    - cron: '0 */6 * * *' # Cada 6 horas
  workflow_dispatch: # Bot√≥n manual
  push:
    branches:
      - main
    paths:
      - '**.zip' # Se activa si subes un ZIP
      - '.github/workflows/**'

jobs:
  deploy-and-fetch:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      # --- PASO DE DESCOMPRESI√ìN AUTOM√ÅTICA ---
      - name: Unzip Source (if exists)
        run: |
          # Busca cualquier archivo .zip en la ra√≠z
          if ls *.zip 1> /dev/null 2>&1; then
            echo "üì¶ ZIP detectado. Descomprimiendo..."
            unzip -o *.zip -d .
            
            # Si el zip cre√≥ una subcarpeta (ej: proyecto/), mover todo a la ra√≠z
            # Esto es com√∫n si zipeas una carpeta en lugar de los archivos
            if [ -d "Mercado-main" ]; then
              cp -r Mercado-main/* .
              rm -rf Mercado-main
            fi
            
            echo "üóëÔ∏è Eliminando ZIP original..."
            rm *.zip
            
            # Configurar git para guardar los cambios de la descompresi√≥n
            git config --global user.name 'GitHub Action'
            git config --global user.email 'action@github.com'
            git add .
            git commit -m "Auto-deploy: Unzipped source files [skip ci]" || echo "Nada que descomprimir o cambios ya aplicados"
          else
            echo "‚úÖ No se encontr√≥ ZIP, procediendo normal."
          fi

      - name: Install Dependencies
        run: |
          npm install yahoo-finance2
          # Instalar dependencias del proyecto si package.json existe
          if [ -f package.json ]; then
            npm install
          fi

      - name: Fetch Financial Data
        run: node scripts/fetch-metrics.js

      - name: Commit Data Changes
        run: |
          git config --global user.name 'GitHub Action'
          git config --global user.email 'action@github.com'
          git add public/data/metrics.json
          # Solo hacer commit si el JSON cambi√≥
          git diff --quiet && git diff --staged --quiet || (git commit -m "Update financial data" && git push)
